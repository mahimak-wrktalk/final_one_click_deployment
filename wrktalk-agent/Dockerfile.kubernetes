FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Helm
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Verify Helm installation
RUN helm version

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy setup.py and application code
COPY setup.py .
COPY src/ ./src/

# Install the package
RUN pip install --no-cache-dir -e .

# Create non-root user
RUN useradd -m -u 1000 agent && \
    chown -R agent:agent /app && \
    mkdir -p /tmp && \
    chown -R agent:agent /tmp

USER agent

# Set deployment type
ENV WRKTALK_AGENT_DEPLOYMENT_TYPE=kubernetes

# Run agent
CMD ["python", "-m", "wrktalk_agent"]
