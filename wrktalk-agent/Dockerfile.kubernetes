FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Helm CLI (for Kubernetes deployments)
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Verify Helm installation
RUN helm version

# Install Docker Compose CLI (for Docker deployments) - NEW for single image
RUN curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose \
    && chmod +x /usr/local/bin/docker-compose

# Verify Docker Compose installation
RUN docker-compose version || true

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy setup.py and application code
COPY setup.py .
COPY src/ ./src/

# Install the package
RUN pip install --no-cache-dir -e .

# Create non-root user
RUN useradd -m -u 1000 agent && \
    chown -R agent:agent /app && \
    mkdir -p /tmp && \
    chown -R agent:agent /tmp

USER agent

# Deployment type is now configured via environment variables at runtime
# No default ENV set here - allows single image for both K8s and Docker

# Run agent
CMD ["python", "-m", "wrktalk_agent"]
